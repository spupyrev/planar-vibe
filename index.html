<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PlanarVibe</title>
  <meta name="keywords" content="graph drawing, planar graphs, algorithms">

  <link href="static/img/favicon.jpg" type="image/ico" rel="shortcut icon" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="static/css/app.css" rel="stylesheet">
</head>


<body>
  <div class="app-shell">
    <div class="logo-block">
      <img alt="PlanarVibe" src="static/img/logo.png">
    </div>

    <div class="row g-3 main-row">
      <section class="col-12 col-lg-auto input-col">
        <div class="panel">
          <form id="graph-form" method="post" action="#" accept-charset="UTF-8" onsubmit="return checkTextArea(this)">
            <div class="wide center">
              <textarea
                name="dotfile"
                id="dotfile"
                class="wide"
                spellcheck="false"
                autofocus="autofocus"
                maxlength="10000000"
                placeholder="Paste a graph edge list..."></textarea>
              <div>
                <span class="muted">...or try an example:</span>
                <br>
                <a class="small-link" onclick="pasteStaticGraph('sample1')">[Sample1]</a>
                <a class="small-link" onclick="pasteStaticGraph('sample2')">[Sample2]</a>
                <a class="small-link" onclick="pasteStaticGraph('sample3')">[Sample3]</a>
                <a class="small-link" onclick="pasteStaticGraph('cycle20')">[Cycle20]</a>
                <a class="small-link" onclick="pasteStaticGraph('ladder20')">[Ladder20]</a>
                <a class="small-link" onclick="pasteStaticGraph('grid9x9')">[Grid 9x9]</a>
                <a class="small-link" onclick="pasteStaticGraph('planar3tree30')">[Planar 3-Tree 30]</a>
              </div>
            </div>

            <div style="margin:10px 0 0">
              <table class="wide center"><tbody>
                <tr>
                  <td style="width:100%; text-align:center">
                    <input id="submit" value="Create Graph" type="submit" class="btn btn-primary btn-sm"/>
                  </td>
                </tr>
              </tbody></table>
            </div>

            <div class="stats-subpanel">
              <div class="stats-title">Statistics</div>
              <label class="form-check stats-check">
                <input class="form-check-input" type="checkbox" id="stat-is-planar" disabled>
                <span class="form-check-label">Is Planar</span>
              </label>
              <label class="form-check stats-check">
                <input class="form-check-input" type="checkbox" id="stat-is-planar-3-tree" disabled>
                <span class="form-check-label">Is Planar 3-Tree</span>
              </label>
            </div>
          </form>
        </div>
      </section>

      <section class="col-12 col-lg draw-col">
        <div class="panel drawing-panel">
          <button type="button" class="btn btn-light btn-sm reset-zoom-btn" onclick="resetZoom()" title="Reset Zoom" aria-label="Reset Zoom">
            <img src="static/img/zoom-reset.svg" alt="">
          </button>
          <div id="cy"></div>
          <div class="layout-toolbar">
            <div class="layout-group">
              <div class="layout-group-title">Generic</div>
              <div class="layout-group-buttons">
                <button type="button" class="btn btn-outline-secondary btn-sm layout-btn" data-layout="random" onclick="applyLayout('random')" title="Deterministic random coordinates by node id">Random</button>
                <button type="button" class="btn btn-outline-secondary btn-sm layout-btn" data-layout="circle" onclick="applyLayout('circle')" title="Place vertices evenly on a circle">Circular</button>
                <button type="button" class="btn btn-outline-secondary btn-sm layout-btn" data-layout="cose" onclick="applyLayout('cose')" title="Force-directed COSE layout">Force-Dir</button>
              </div>
            </div>
            <div class="layout-group">
              <div class="layout-group-title">Planar</div>
              <div class="layout-group-buttons">
                <button type="button" class="btn btn-outline-secondary btn-sm layout-btn" data-layout="tutte" onclick="applyLayout('tutte')" title="Tutte barycentric layout for planar graphs">Tutte</button>
                <button type="button" class="btn btn-outline-secondary btn-sm layout-btn" data-layout="p3t" onclick="applyLayout('p3t')" title="Equal-face-area style layout for planar 3-trees">P3T</button>
                <button type="button" class="btn btn-outline-secondary btn-sm layout-btn" data-layout="fpp" onclick="applyLayout('fpp')" title="FPP prototype layout (currently planar 3-tree path)">FPP</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="row g-3 status-row">
      <section class="col-12">
        <div class="panel status-panel">
          <div class="status-title">Status Bar</div>
          <div id="status"></div>
        </div>
      </section>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
  <script src="static/js/graph-generator.js"></script>
  <script src="static/js/planarvibe-plugin.js"></script>
  <script src="static/js/planar-graph-core.js"></script>
  <script src="static/js/planarity-test.js"></script>
  <script src="static/js/tutte-layout.js"></script>
  <script src="static/js/p3t-layout.js"></script>
  <script src="static/js/fpp-layout.js"></script>
  <script>
    var LOGO_COLORS = {
      blue: '#1060A8',
      orange: '#EA9624',
      green: '#609818',
      ink: '#103870',
      black: '#111111'
    };

    var currentParsed = null;

    var cy = cytoscape({
      container: document.getElementById('cy'),
      elements: [],
      style: [
        {
          selector: 'node',
          style: {
            'background-color': LOGO_COLORS.blue,
            'border-color': LOGO_COLORS.black,
            'border-width': 0.5,
            'label': 'data(label)',
            'color': '#ffffff',
            'font-size': 11,
            'text-valign': 'center',
            'text-halign': 'center',
            'width': 28,
            'height': 28
          }
        },
        {
          selector: 'edge',
          style: {
            'line-color': LOGO_COLORS.black,
            'width': 2,
            'curve-style': 'bezier'
          }
        }
      ],
      layout: { name: 'grid' }
    });

    function setStatus(message, isError) {
      $('#status').text(message).css('color', isError ? '#ba1b1b' : LOGO_COLORS.ink);
    }

    function setStatistics(stats) {
      var s = stats || {};
      $('#stat-is-planar').prop('checked', !!s.isPlanar).prop('disabled', true);
      $('#stat-is-planar-3-tree').prop('checked', !!s.isPlanar3Tree).prop('disabled', true);
    }

    function setTutteEnabled(isEnabled) {
      var $btn = $('.layout-btn[data-layout="tutte"]');
      $btn.prop('disabled', !isEnabled);
      if (!isEnabled) {
        $btn.removeClass('is-active');
      }
    }

    function setP3TEnabled(isEnabled) {
      var $btn = $('.layout-btn[data-layout="p3t"]');
      $btn.prop('disabled', !isEnabled);
      if (!isEnabled) {
        $btn.removeClass('is-active');
      }
    }

    function setFPPEnabled(isEnabled) {
      var $btn = $('.layout-btn[data-layout="fpp"]');
      $btn.prop('disabled', !isEnabled);
      if (!isEnabled) {
        $btn.removeClass('is-active');
      }
    }

    function edgePairsFromParsed(parsed) {
      var pairs = [];
      if (!parsed || !parsed.elements) {
        return pairs;
      }

      for (var i = 0; i < parsed.elements.length; i += 1) {
        var el = parsed.elements[i];
        if (el && el.data && el.data.source !== undefined && el.data.target !== undefined) {
          pairs.push([String(el.data.source), String(el.data.target)]);
        }
      }
      return pairs;
    }

    function updateStatistics(parsed) {
      if (!parsed || !parsed.elements) {
        setStatistics({ isPlanar: false, isPlanar3Tree: false });
        setTutteEnabled(false);
        setP3TEnabled(false);
        setFPPEnabled(false);
        return;
      }

      if (!window.PlanarVibePlanarityTest || !window.PlanarVibePlanarityTest.computePlanarEmbedding) {
        setStatistics({ isPlanar: false, isPlanar3Tree: false });
        setTutteEnabled(false);
        setP3TEnabled(false);
        setFPPEnabled(false);
        return;
      }

      var nodeIds = cy.nodes().map(function (node) {
        return String(node.id());
      });
      var edgePairs = edgePairsFromParsed(parsed);
      var embedding = PlanarVibePlanarityTest.computePlanarEmbedding(nodeIds, edgePairs);
      var isPlanar = !!(embedding && embedding.ok);
      var isPlanar3Tree = false;
      if (isPlanar && PlanarVibePlanarityTest.isPlanar3Tree) {
        isPlanar3Tree = !!PlanarVibePlanarityTest.isPlanar3Tree(nodeIds, edgePairs);
      }
      setStatistics({ isPlanar: isPlanar, isPlanar3Tree: isPlanar3Tree });
      setTutteEnabled(isPlanar);
      setP3TEnabled(isPlanar3Tree);
      setFPPEnabled(isPlanar);
    }

    function drawGraph() {
      try {
        currentParsed = PlanarVibePlugin.parseEdgeList($('#dotfile').val());
        cy.elements().remove();
        cy.add(currentParsed.elements);
        updateStatistics(currentParsed);
        applyLayout('random');
        setStatus('Drawn ' + currentParsed.nodeCount + ' nodes and ' + currentParsed.edgeCount + ' edges (random coordinates)', false);
      } catch (error) {
        setStatistics({ isPlanar: false, isPlanar3Tree: false });
        setTutteEnabled(false);
        setP3TEnabled(false);
        setFPPEnabled(false);
        setStatus(error.message, true);
      }
    }

    function checkTextArea() {
      var value = $('#dotfile').val().trim();
      if (!value) {
        setStatus('Please paste a graph first', true);
        return false;
      }
      drawGraph();
      return false;
    }

    function pasteStaticGraph(name) {
      var sampleGraph = PlanarVibeGraphGenerator.getSample(name);
      if (!sampleGraph) {
        setStatus('Unknown sample: ' + name + '.', true);
        return;
      }

      $('#dotfile').val(sampleGraph);
      drawGraph();
    }

    function applyLayout(layoutName) {
      if (cy.nodes().length === 0) {
        return;
      }
      setSelectedLayoutButton(layoutName);

      if (layoutName === 'random') {
        PlanarVibePlugin.applyDeterministicRandomPositions(cy);
        setStatus('Applied random coordinates', false);
        return;
      }

      if (layoutName === 'tutte') {
        if ($('.layout-btn[data-layout="tutte"]').prop('disabled')) {
          setStatus('Tutte layout requires a planar graph.', true);
          return;
        }
        var result = PlanarVibeTutte.applyTutteLayout(cy);
        setStatus(result.message, !result.ok);
        return;
      }

      if (layoutName === 'p3t') {
        if ($('.layout-btn[data-layout="p3t"]').prop('disabled')) {
          setStatus('P3T layout requires a planar 3-tree.', true);
          return;
        }
        if (!window.PlanarVibeP3T || !window.PlanarVibeP3T.applyP3TLayout) {
          setStatus('P3T layout module is missing.', true);
          return;
        }
        var result = PlanarVibeP3T.applyP3TLayout(cy);
        setStatus(result.message, !result.ok);
        return;
      }

      if (layoutName === 'fpp') {
        if ($('.layout-btn[data-layout="fpp"]').prop('disabled')) {
          setStatus('FPP layout requires a planar graph.', true);
          return;
        }
        if (!window.PlanarVibeFPP || !window.PlanarVibeFPP.applyFPPLayout) {
          setStatus('FPP layout module is missing.', true);
          return;
        }
        var fppResult = PlanarVibeFPP.applyFPPLayout(cy);
        setStatus(fppResult.message, !fppResult.ok);
        return;
      }

      cy.layout(PlanarVibePlugin.layoutOptionsByName(layoutName, currentParsed)).run();
      setStatus('Applied ' + layoutName + ' layout', false);
    }

    function setSelectedLayoutButton(layoutName) {
      $('.layout-btn').removeClass('is-active');
      $('.layout-btn[data-layout="' + layoutName + '"]').addClass('is-active');
    }

    function resetZoom() {
      if (cy.nodes().length === 0) {
        return;
      }
      cy.fit(undefined, 20);
      cy.center();
      setStatus('Zoom reset.', false);
    }

    window.checkTextArea = checkTextArea;
    window.pasteStaticGraph = pasteStaticGraph;
    window.applyLayout = applyLayout;
    window.resetZoom = resetZoom;

    pasteStaticGraph(PlanarVibeGraphGenerator.defaultSample);
  </script>
</body>
</html>
