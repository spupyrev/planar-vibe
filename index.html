<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>PlanarVibe</title>
  <meta name="keywords" content="graph drawing, planar graphs, algorithms">

  <link href="static/img/favicon.jpg" type="image/ico" rel="shortcut icon" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="static/css/app.css" rel="stylesheet">
</head>


<body>
  <div class="app-shell">
    <div class="logo-block">
      <img alt="PlanarVibe" src="static/img/logo.png">
    </div>

    <div class="row g-3 main-row">
      <section class="col-12 col-lg-auto input-col">
        <div class="panel">
          <form id="graph-form" method="post" action="#" accept-charset="UTF-8" onsubmit="return checkTextArea(this)">
            <div class="wide center">
              <textarea
                name="dotfile"
                id="dotfile"
                class="wide"
                spellcheck="false"
                autofocus="autofocus"
                maxlength="10000000"
                placeholder="Paste a graph edge list..."></textarea>
              <div>
                <span class="muted">...or try an example:</span>
                <br>
                <a class="small-link" onclick="pasteStaticGraph('sample1')">[Sample1]</a>
                <a class="small-link" onclick="pasteStaticGraph('sample2')">[Sample2]</a>
                <a class="small-link" onclick="pasteStaticGraph('sample3')">[Sample3]</a>
                <a class="small-link" onclick="pasteStaticGraph('cycle20')">[Cycle20]</a>
                <a class="small-link" onclick="pasteStaticGraph('ladder20')">[Ladder20]</a>
                <a class="small-link" onclick="pasteStaticGraph('grid9x9')">[Grid 9x9]</a>
                <a class="small-link" onclick="pasteStaticGraph('planar3tree10')">[Planar 3-Tree 10]</a>
                <a class="small-link" onclick="pasteStaticGraph('planar3tree30')">[Planar 3-Tree 30]</a>
              </div>
            </div>

            <div style="margin:10px 0 0">
              <table class="wide center"><tbody>
                <tr>
                  <td style="width:100%; text-align:center">
                    <input id="submit" value="Create Graph" type="submit" class="btn btn-primary btn-sm"/>
                  </td>
                </tr>
              </tbody></table>
            </div>

            <div class="stats-subpanel">
              <div class="stats-title">Statistics</div>
              <label class="form-check stats-check">
                <input class="form-check-input" type="checkbox" id="stat-is-planar" disabled>
                <span class="form-check-label">Is Planar</span>
              </label>
              <label class="form-check stats-check">
                <input class="form-check-input" type="checkbox" id="stat-is-planar-3-tree" disabled>
                <span class="form-check-label">Is Planar 3-Tree</span>
              </label>
            </div>
          </form>
        </div>
      </section>

      <section class="col-12 col-lg draw-col">
        <div class="panel drawing-panel">
          <button type="button" class="btn btn-light btn-sm reset-zoom-btn" onclick="resetZoom()" title="Reset Zoom" aria-label="Reset Zoom">
            <img src="static/img/zoom-reset.svg" alt="">
          </button>
          <div class="style-controls" aria-label="Style controls">
            <div class="style-control-row">
              <label for="vertex-size-slider" title="Vertex size">Vertex</label>
              <input id="vertex-size-slider" type="range" min="8" max="30" step="1" title="Vertex size">
              <span id="vertex-size-value" class="style-control-value"></span>
            </div>
            <div class="style-control-row">
              <label for="edge-width-slider" title="Edge width">Edge</label>
              <input id="edge-width-slider" type="range" min="1" max="8" step="0.5" title="Edge width">
              <span id="edge-width-value" class="style-control-value"></span>
            </div>
          </div>
          <div id="cy"></div>
          <div class="layout-toolbar">
            <div class="layout-group">
              <div class="layout-group-title">Generic</div>
              <div class="layout-group-buttons">
                <button type="button" class="btn btn-outline-secondary btn-sm layout-btn" data-layout="random" onclick="applyLayout('random')" title="Deterministic random coordinates by node id">Random</button>
                <button type="button" class="btn btn-outline-secondary btn-sm layout-btn" data-layout="circle" onclick="applyLayout('circle')" title="Place vertices evenly on a circle">Circular</button>
                <button type="button" class="btn btn-outline-secondary btn-sm layout-btn" data-layout="cose" onclick="applyLayout('cose')" title="Force-directed COSE layout">Force-Dir</button>
              </div>
            </div>
            <div class="layout-group">
              <div class="layout-group-title">Planar</div>
              <div class="layout-group-buttons">
                <button type="button" class="btn btn-outline-secondary btn-sm layout-btn" data-layout="tutte" onclick="applyLayout('tutte')" title="Tutte barycentric layout for planar graphs">Tutte</button>
                <button type="button" class="btn btn-outline-secondary btn-sm layout-btn" data-layout="p3t" onclick="applyLayout('p3t')" title="Equal-face-area style layout for planar 3-trees">P3T</button>
                <button type="button" class="btn btn-outline-secondary btn-sm layout-btn" data-layout="fpp" onclick="applyLayout('fpp')" title="FPP prototype layout (currently planar 3-tree path)">FPP</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <div class="row g-3 status-row">
      <section class="col-12">
        <div class="panel status-panel">
          <div class="status-title">Status Bar</div>
          <div id="status"></div>
        </div>
      </section>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
  <script src="static/js/graph-generator.js"></script>
  <script src="static/js/planarvibe-plugin.js"></script>
  <script src="static/js/planar-graph-core.js"></script>
  <script src="static/js/planarity-test.js"></script>
  <script src="static/js/tutte-layout.js"></script>
  <script src="static/js/p3t-layout.js"></script>
  <script src="static/js/fpp-layout.js"></script>
  <script>
    var LOGO_COLORS = {
      blue: '#1060A8',
      orange: '#EA9624',
      green: '#609818',
      ink: '#103870',
      black: '#111111'
    };

    var currentParsed = null;
    var GRAPH_STYLE_COOKIE_DAYS = 365;
    var DEFAULT_VERTEX_SIZE = 15;
    var DEFAULT_EDGE_WIDTH = 1;
    var PREF_VERTEX_SIZE_KEY = 'planarvibe_vertex_size';
    var PREF_EDGE_WIDTH_KEY = 'planarvibe_edge_width';

    function writeCookie(name, value, days) {
      var d = new Date();
      d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
      document.cookie = name + '=' + encodeURIComponent(String(value)) + ';expires=' + d.toUTCString() + ';path=/;SameSite=Lax';
    }

    function readCookie(name) {
      var prefix = name + '=';
      var parts = document.cookie ? document.cookie.split(';') : [];
      for (var i = 0; i < parts.length; i += 1) {
        var c = parts[i].trim();
        if (c.indexOf(prefix) === 0) {
          return decodeURIComponent(c.substring(prefix.length));
        }
      }
      return null;
    }

    function readNumericCookie(name, fallback, min, max) {
      var raw = readCookie(name);
      var value = Number(raw);
      if (!Number.isFinite(value)) {
        return fallback;
      }
      if (value < min || value > max) {
        return fallback;
      }
      return value;
    }

    function readStorage(name) {
      try {
        if (window.localStorage) {
          var v = window.localStorage.getItem(name);
          if (v !== null && v !== undefined) {
            return v;
          }
        }
      } catch (e) {}
      return readCookie(name);
    }

    function writeStorage(name, value) {
      try {
        if (window.localStorage) {
          window.localStorage.setItem(name, String(value));
        }
      } catch (e) {}
      writeCookie(name, value, GRAPH_STYLE_COOKIE_DAYS);
    }

    function readNumericPreference(name, fallback, min, max) {
      var raw = readStorage(name);
      var value = Number(raw);
      if (!Number.isFinite(value)) {
        return fallback;
      }
      if (value < min || value > max) {
        return fallback;
      }
      return value;
    }

    var graphStylePrefs = {
      vertexSize: readNumericPreference(PREF_VERTEX_SIZE_KEY, DEFAULT_VERTEX_SIZE, 8, 30),
      edgeWidth: readNumericPreference(PREF_EDGE_WIDTH_KEY, DEFAULT_EDGE_WIDTH, 1, 8)
    };

    function computeNodeFontSize(vertexSize) {
      return Math.max(6, Math.round(vertexSize * 0.45));
    }

    var cy = cytoscape({
      container: document.getElementById('cy'),
      elements: [],
      wheelSensitivity: 0.15,
      style: [
        {
          selector: 'node',
          style: {
            'background-color': LOGO_COLORS.blue,
            'border-color': LOGO_COLORS.black,
            'border-width': 0.5,
            'label': 'data(label)',
            'color': '#ffffff',
            'font-size': computeNodeFontSize(graphStylePrefs.vertexSize),
            'text-valign': 'center',
            'text-halign': 'center',
            'width': graphStylePrefs.vertexSize,
            'height': graphStylePrefs.vertexSize
          }
        },
        {
          selector: 'edge',
          style: {
            'line-color': LOGO_COLORS.black,
            'width': graphStylePrefs.edgeWidth,
            'curve-style': 'bezier'
          }
        }
      ],
      layout: { name: 'grid' }
    });

    function setStatus(message, isError) {
      $('#status').text(message).css('color', isError ? '#ba1b1b' : LOGO_COLORS.ink);
    }

    function applyGraphAppearance() {
      cy.style()
        .selector('node')
        .style({
          'width': graphStylePrefs.vertexSize,
          'height': graphStylePrefs.vertexSize,
          'font-size': computeNodeFontSize(graphStylePrefs.vertexSize)
        })
        .selector('edge')
        .style({
          'width': graphStylePrefs.edgeWidth
        })
        .update();
    }

    function updateStyleControlsUI() {
      $('#vertex-size-slider').val(String(graphStylePrefs.vertexSize));
      $('#edge-width-slider').val(String(graphStylePrefs.edgeWidth));
      $('#vertex-size-value').text(String(graphStylePrefs.vertexSize));
      $('#edge-width-value').text(String(graphStylePrefs.edgeWidth));
    }

    function initStyleControls() {
      updateStyleControlsUI();
      applyGraphAppearance();

      $('#vertex-size-slider').on('input change', function () {
        graphStylePrefs.vertexSize = Number($(this).val()) || DEFAULT_VERTEX_SIZE;
        updateStyleControlsUI();
        applyGraphAppearance();
        writeStorage(PREF_VERTEX_SIZE_KEY, graphStylePrefs.vertexSize);
      });

      $('#edge-width-slider').on('input change', function () {
        graphStylePrefs.edgeWidth = Number($(this).val()) || DEFAULT_EDGE_WIDTH;
        updateStyleControlsUI();
        applyGraphAppearance();
        writeStorage(PREF_EDGE_WIDTH_KEY, graphStylePrefs.edgeWidth);
      });
    }

    function smallGraphCoordinatesSuffix() {
      if (cy.nodes().length === 0 || cy.nodes().length > 10) {
        return '';
      }

      var nodes = cy.nodes().toArray().slice();
      nodes.sort(function (a, b) {
        var ai = String(a.id());
        var bi = String(b.id());
        var an = Number(ai);
        var bn = Number(bi);
        var aNum = Number.isFinite(an);
        var bNum = Number.isFinite(bn);
        if (aNum && bNum) {
          return an - bn;
        }
        return ai.localeCompare(bi);
      });

      var parts = [];
      for (var i = 0; i < nodes.length; i += 1) {
        var node = nodes[i];
        var p = node.position();
        if (!p || !Number.isFinite(p.x) || !Number.isFinite(p.y)) {
          continue;
        }
        parts.push(node.id() + '=(' + Math.round(p.x) + ',' + Math.round(p.y) + ')');
      }
      if (parts.length === 0) {
        return '';
      }
      return ' | coords: ' + parts.join(' ');
    }

    function setLayoutStatus(message, isError) {
      if (isError) {
        setStatus(message, true);
        return;
      }
      setStatus(message + smallGraphCoordinatesSuffix(), false);
    }

    function normalizeLayoutScale() {
      var nodes = cy.nodes();
      if (!nodes || nodes.length === 0) {
        return;
      }

      var minX = Infinity;
      var minY = Infinity;
      var maxX = -Infinity;
      var maxY = -Infinity;

      nodes.forEach(function (node) {
        var p = node.position();
        if (!p || !Number.isFinite(p.x) || !Number.isFinite(p.y)) {
          return;
        }
        if (p.x < minX) minX = p.x;
        if (p.y < minY) minY = p.y;
        if (p.x > maxX) maxX = p.x;
        if (p.y > maxY) maxY = p.y;
      });

      if (!isFinite(minX) || !isFinite(minY) || !isFinite(maxX) || !isFinite(maxY)) {
        return;
      }

      var width = maxX - minX;
      var height = maxY - minY;
      var pad = 24;
      var targetWidth = 900;
      var targetHeight = 620;
      var safeW = Math.max(1e-9, width);
      var safeH = Math.max(1e-9, height);
      var scale = Math.min((targetWidth - 2 * pad) / safeW, (targetHeight - 2 * pad) / safeH);

      if (!Number.isFinite(scale) || scale <= 0) {
        return;
      }

      // Keep tiny/degenerate drawings readable.
      if (width < 1e-9 && height < 1e-9) {
        var single = nodes[0];
        if (single) {
          single.position({ x: targetWidth / 2, y: targetHeight / 2 });
        }
        cy.fit(undefined, 24);
        return;
      }

      nodes.forEach(function (node) {
        var p = node.position();
        if (!p || !Number.isFinite(p.x) || !Number.isFinite(p.y)) {
          return;
        }
        node.position({
          x: (p.x - minX) * scale + pad,
          y: (p.y - minY) * scale + pad
        });
      });

      cy.fit(undefined, 24);
    }

    function setStatistics(stats) {
      var s = stats || {};
      $('#stat-is-planar').prop('checked', !!s.isPlanar).prop('disabled', true);
      $('#stat-is-planar-3-tree').prop('checked', !!s.isPlanar3Tree).prop('disabled', true);
    }

    function setTutteEnabled(isEnabled) {
      var $btn = $('.layout-btn[data-layout="tutte"]');
      $btn.prop('disabled', !isEnabled);
      if (!isEnabled) {
        $btn.removeClass('is-active');
      }
    }

    function setP3TEnabled(isEnabled) {
      var $btn = $('.layout-btn[data-layout="p3t"]');
      $btn.prop('disabled', !isEnabled);
      if (!isEnabled) {
        $btn.removeClass('is-active');
      }
    }

    function setFPPEnabled(isEnabled) {
      var $btn = $('.layout-btn[data-layout="fpp"]');
      $btn.prop('disabled', !isEnabled);
      if (!isEnabled) {
        $btn.removeClass('is-active');
      }
    }

    function edgePairsFromParsed(parsed) {
      var pairs = [];
      if (!parsed || !parsed.elements) {
        return pairs;
      }

      for (var i = 0; i < parsed.elements.length; i += 1) {
        var el = parsed.elements[i];
        if (el && el.data && el.data.source !== undefined && el.data.target !== undefined) {
          pairs.push([String(el.data.source), String(el.data.target)]);
        }
      }
      return pairs;
    }

    function updateStatistics(parsed) {
      if (!parsed || !parsed.elements) {
        setStatistics({ isPlanar: false, isPlanar3Tree: false });
        setTutteEnabled(false);
        setP3TEnabled(false);
        setFPPEnabled(false);
        return;
      }

      if (!window.PlanarVibePlanarityTest || !window.PlanarVibePlanarityTest.computePlanarEmbedding) {
        setStatistics({ isPlanar: false, isPlanar3Tree: false });
        setTutteEnabled(false);
        setP3TEnabled(false);
        setFPPEnabled(false);
        return;
      }

      var nodeIds = cy.nodes().map(function (node) {
        return String(node.id());
      });
      var edgePairs = edgePairsFromParsed(parsed);
      var embedding = PlanarVibePlanarityTest.computePlanarEmbedding(nodeIds, edgePairs);
      var isPlanar = !!(embedding && embedding.ok);
      var isPlanar3Tree = false;
      if (isPlanar && PlanarVibePlanarityTest.isPlanar3Tree) {
        isPlanar3Tree = !!PlanarVibePlanarityTest.isPlanar3Tree(nodeIds, edgePairs);
      }
      setStatistics({ isPlanar: isPlanar, isPlanar3Tree: isPlanar3Tree });
      setTutteEnabled(isPlanar);
      setP3TEnabled(isPlanar3Tree);
      setFPPEnabled(isPlanar);
    }

    function drawGraph() {
      try {
        currentParsed = PlanarVibePlugin.parseEdgeList($('#dotfile').val());
        cy.elements().remove();
        cy.add(currentParsed.elements);
        updateStatistics(currentParsed);
        applyLayout('random');
        setLayoutStatus('Drawn ' + currentParsed.nodeCount + ' nodes and ' + currentParsed.edgeCount + ' edges (random coordinates)', false);
      } catch (error) {
        setStatistics({ isPlanar: false, isPlanar3Tree: false });
        setTutteEnabled(false);
        setP3TEnabled(false);
        setFPPEnabled(false);
        setStatus(error.message, true);
      }
    }

    function checkTextArea() {
      var value = $('#dotfile').val().trim();
      if (!value) {
        setStatus('Please paste a graph first', true);
        return false;
      }
      drawGraph();
      return false;
    }

    function pasteStaticGraph(name) {
      var sampleGraph = PlanarVibeGraphGenerator.getSample(name);
      if (!sampleGraph) {
        setStatus('Unknown sample: ' + name + '.', true);
        return;
      }

      $('#dotfile').val(sampleGraph);
      drawGraph();
    }

    function applyLayout(layoutName) {
      if (cy.nodes().length === 0) {
        return;
      }
      setSelectedLayoutButton(layoutName);

      if (layoutName === 'random') {
        PlanarVibePlugin.applyDeterministicRandomPositions(cy);
        normalizeLayoutScale();
        setLayoutStatus('Applied random coordinates', false);
        return;
      }

      if (layoutName === 'tutte') {
        if ($('.layout-btn[data-layout="tutte"]').prop('disabled')) {
          setStatus('Tutte layout requires a planar graph.', true);
          return;
        }
        var result = PlanarVibeTutte.applyTutteLayout(cy);
        if (result.ok) {
          normalizeLayoutScale();
        }
        setLayoutStatus(result.message, !result.ok);
        return;
      }

      if (layoutName === 'p3t') {
        if ($('.layout-btn[data-layout="p3t"]').prop('disabled')) {
          setStatus('P3T layout requires a planar 3-tree.', true);
          return;
        }
        if (!window.PlanarVibeP3T || !window.PlanarVibeP3T.applyP3TLayout) {
          setStatus('P3T layout module is missing.', true);
          return;
        }
        var result = PlanarVibeP3T.applyP3TLayout(cy);
        if (result.ok) {
          normalizeLayoutScale();
        }
        setLayoutStatus(result.message, !result.ok);
        return;
      }

      if (layoutName === 'fpp') {
        if ($('.layout-btn[data-layout="fpp"]').prop('disabled')) {
          setStatus('FPP layout requires a planar graph.', true);
          return;
        }
        if (!window.PlanarVibeFPP || !window.PlanarVibeFPP.applyFPPLayout) {
          setStatus('FPP layout module is missing.', true);
          return;
        }
        var fppResult = PlanarVibeFPP.applyFPPLayout(cy);
        if (fppResult.ok) {
          normalizeLayoutScale();
        }
        setLayoutStatus(fppResult.message, !fppResult.ok);
        return;
      }

      var layout = cy.layout(PlanarVibePlugin.layoutOptionsByName(layoutName, currentParsed));
      if (layout && layout.one) {
        layout.one('layoutstop', function () {
          normalizeLayoutScale();
          setLayoutStatus('Applied ' + layoutName + ' layout', false);
        });
      } else {
        setTimeout(function () {
          normalizeLayoutScale();
          setLayoutStatus('Applied ' + layoutName + ' layout', false);
        }, 0);
      }
      layout.run();
    }

    function setSelectedLayoutButton(layoutName) {
      $('.layout-btn').removeClass('is-active');
      $('.layout-btn[data-layout="' + layoutName + '"]').addClass('is-active');
    }

    function resetZoom() {
      if (cy.nodes().length === 0) {
        return;
      }
      cy.fit(undefined, 20);
      cy.center();
      setStatus('Zoom reset.', false);
    }

    window.checkTextArea = checkTextArea;
    window.pasteStaticGraph = pasteStaticGraph;
    window.applyLayout = applyLayout;
    window.resetZoom = resetZoom;

    initStyleControls();
    pasteStaticGraph(PlanarVibeGraphGenerator.defaultSample);
  </script>
</body>
</html>
